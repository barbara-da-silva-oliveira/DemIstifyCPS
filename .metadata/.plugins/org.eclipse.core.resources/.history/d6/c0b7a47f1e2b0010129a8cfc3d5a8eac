/*
 * generated by Xtext 2.38.0
 */
package fr.inria.kairos.influence.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.jgrapht.graph.*
import org.jgrapht.nio.dot.DOTExporter
import java.io.StringWriter
import org.jgrapht.alg.cycle.CycleDetector
import fr.inria.kairos.influence.metamodel.influenceMetamodel.Influence

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class InfluenceDSLGenerator extends AbstractGenerator {

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
//		var infoFile = 'Quick Info:'
//		val jsonFile = new StringBuilder
//		jsonFile.append("{\n\t\"influences\": [\n")
//		var graph = new DefaultDirectedGraph<String,DefaultEdge>(DefaultEdge)
//		
//		val ite = resource.allContents
//		
//		while (ite.hasNext){
//			val content = ite.next
//			if (content instanceof Influence) {
//            	val inf = content as Influence
//				jsonFile.append("\t\t{\n")
//	            jsonFile.append("\t\t\t\"name\": \"").append(inf.name).append("\",\n")
//	            jsonFile.append("\t\t\t\"sources\": \"")
//	                       .append(inf.sourceArtifact.join(", ")).append("\",\n")
//	            jsonFile.append("\t\t\t\"targets\": \"")
//	                       .append(inf.targetArtifact.join(", ")).append("\"\n")
//	            jsonFile.append("\t\t},\n")
//	            
//	            infoFile += inf.name+ ":" + inf.sourceArtifact + "\n\t->\n\t" + inf.targetArtifact +'\n'
//	            for (sourceName : inf.sourceArtifact){
//	            	for (targetName: inf.targetArtifact){
//	            		graph.addVertex(sourceName)
//						graph.addVertex(targetName)
//						graph.addEdge(sourceName, targetName)
//						detectCycle(graph)
//	            	}
//		        
//				}
//			}
//		}
//		exportGraphToDot(graph, fsa, "influenceGraph.dot")
//		fsa.generateFile("influences.json", jsonFile.toString)
//		fsa.generateFile("info.txt", infoFile.toString)
//		
//	}
//	
//	def void exportGraphToDot(DefaultDirectedGraph<String, DefaultEdge> graph, IFileSystemAccess2 fsa, String filename) {
//    	val dotExporter = new DOTExporter<String, DefaultEdge>()
//    	val writer = new StringWriter
//    	dotExporter.exportGraph(graph, writer)
//    	fsa.generateFile(filename, writer.toString)
//    	
//    	}
//    	
//    def static boolean detectCycle(DefaultDirectedGraph<String, DefaultEdge> graph){
//    	val cycleDetector = new CycleDetector<String, DefaultEdge>(graph)
//			if (cycleDetector.detectCycles()){
//				println("Cycle detected" + cycleDetector.findCycles())
//				return true
//			} else {
//				println("No cycles detected")
//				return false
//			}
    }
}
